{
  "kind": "build_request",
  "title": "Fix production blank screen by removing startup URL mutation in actor initialization",
  "projectName": "CSWA Task Manager",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-74",
      "text": "Stop reading or mutating the browser URL for `caffeineAdminToken` during actor creation so the app can render routes reliably (no startup freeze/blank screen). Update `frontend/src/hooks/useActor.ts` to remove the call to `getSecretParameter('caffeineAdminToken')` and instead read the token only from `sessionStorage` (via `getSessionParameter('caffeineAdminToken')` from `frontend/src/utils/urlParams.ts`).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-1"
        ],
        "quotes": [
          "still not loading"
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/hooks/useActor.ts` no longer imports or calls `getSecretParameter` (or any URL-reading helper that can call `history.replaceState`).",
        "Actor initialization does not call `history.replaceState` or otherwise change `window.location` during initial render / router bootstrap.",
        "App loads (no blank screen) when opening any route directly (e.g., `/`, `/tasks`, `/dashboard`) with and without a `#caffeineAdminToken=...` or `#/route?caffeineAdminToken=...` fragment present."
      ]
    },
    {
      "id": "REQ-75",
      "text": "Update actor initialization so `_initializeAccessControlWithSecret` is called only when a non-empty `caffeineAdminToken` exists in `sessionStorage`; do not call `_initializeAccessControlWithSecret` with an empty string token.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-1"
        ],
        "quotes": [
          "still not loading"
        ]
      },
      "acceptanceCriteria": [
        "When `sessionStorage.getItem('caffeineAdminToken')` is `null` or an empty/whitespace-only string, `useActor` creates the authenticated actor (when signed in) without calling `_initializeAccessControlWithSecret`.",
        "When `sessionStorage` contains a non-empty token, `_initializeAccessControlWithSecret(token)` is invoked exactly once per actor creation and does not block initial rendering indefinitely."
      ]
    },
    {
      "id": "REQ-76",
      "text": "Ensure deferred token capture + URL cleanup remains the only code path that reads `caffeineAdminToken` from the URL, and it runs only after mount via `useDeferredUrlCleanup` (keep all user-facing text in English).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-1"
        ],
        "quotes": [
          "still not loading"
        ]
      },
      "acceptanceCriteria": [
        "No code path other than `frontend/src/hooks/useDeferredUrlCleanup.ts` reads `caffeineAdminToken` from `window.location`.",
        "`useDeferredUrlCleanup` continues to (a) read the token using `readSecretFromHashNonMutating`, (b) store it to sessionStorage, and (c) clear it from the URL only inside an effect after the app has mounted.",
        "With a URL containing a token, the app renders first paint successfully before the token is removed from the address bar."
      ]
    }
  ],
  "constraints": [
    "Frontend files under `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useActor.ts` is editable, but paths listed in `frontend.immutablePaths` must not be edited.",
    "Do not introduce any non-supported backend technologies or external services.",
    "Keep all user-facing text in English."
  ],
  "nonGoals": [
    "Adding new product features unrelated to fixing the app loading issue.",
    "Changing backend data models or Motoko state as part of this fix."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}