{
  "kind": "build_request",
  "title": "Fix startup Loading-screen hang by deferring admin-token URL handling",
  "projectName": "CSWA Task Manager",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-70",
      "text": "Stop mutating or reading the browser URL for caffeineAdminToken during initial actor creation so the app cannot hang on the startup \"Loading...\" screen.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6",
          "msg-7"
        ],
        "quotes": [
          "fix now",
          "the problem is caused by this line in `useActor.ts`: `const adminToken = getSecretParameter('caffeineAdminToken')`"
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/hooks/useActor.ts` no longer calls `getSecretParameter('caffeineAdminToken')` (or any other URL-reading helper) during actor initialization.",
        "Actor initialization does not call any helper that can invoke `history.replaceState` (directly or indirectly) during the `useQuery` `queryFn` in `useActor`.",
        "With a URL containing `#caffeineAdminToken=<token>`, the app renders past the startup Loading screen and the router can render the root route reliably before any URL cleanup occurs."
      ]
    },
    {
      "id": "REQ-71",
      "text": "Update actor initialization to read caffeineAdminToken only from sessionStorage and call `_initializeAccessControlWithSecret` only when a non-empty token exists.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Switching it to read the token only from sessionStorage",
          "Ensuring the token is captured only after mount via `useDeferredUrlCleanup`"
        ]
      },
      "acceptanceCriteria": [
        "`useActor` reads caffeineAdminToken via a sessionStorage-based helper (e.g., `getSessionParameter('caffeineAdminToken')`) and never from the URL.",
        "`_initializeAccessControlWithSecret` is not called when the token is missing, null, empty string, or whitespace-only.",
        "When a valid token is present in sessionStorage, `_initializeAccessControlWithSecret` is called exactly once per actor creation and the authenticated experience functions as before."
      ]
    },
    {
      "id": "REQ-72",
      "text": "Make `readSecretFromHashNonMutating('caffeineAdminToken')` robust for both hash styles: (1) `#caffeineAdminToken=...` and (2) `#/route?caffeineAdminToken=...`, without mutating the URL.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "This matches your screenshot: the URL still contains `#caffeineAdminToken=...` while the page is stuck."
        ]
      },
      "acceptanceCriteria": [
        "`readSecretFromHashNonMutating` correctly returns the token for `window.location.hash` equal to `#caffeineAdminToken=<token>`.",
        "`readSecretFromHashNonMutating` correctly returns the token for `window.location.hash` equal to `#/tasks?caffeineAdminToken=<token>` (and similar routes).",
        "`readSecretFromHashNonMutating` never calls `clearParamFromHash` or any API that mutates `window.location`/`window.history`.",
        "If the token is not present, the function returns null and does not throw for malformed/unexpected hash contents."
      ]
    },
    {
      "id": "REQ-73",
      "text": "Ensure deferred token capture + URL cleanup (useDeferredUrlCleanup) is the only code path that reads caffeineAdminToken from the URL and that the cleanup runs only after mount.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Ensuring the token is captured only after mount via `useDeferredUrlCleanup`"
        ]
      },
      "acceptanceCriteria": [
        "The only place in the codebase that reads caffeineAdminToken from `window.location` is `frontend/src/hooks/useDeferredUrlCleanup.ts` (via `readSecretFromHashNonMutating`).",
        "URL cleanup (`clearParamFromHash('caffeineAdminToken')`) happens only inside the post-mount effect in `useDeferredUrlCleanup`, never during router creation or initial route validation.",
        "After mount, if caffeineAdminToken was present in the URL, it is persisted to sessionStorage and removed from the address bar without a page reload."
      ]
    }
  ],
  "constraints": [
    "Frontend immutable paths must not be modified: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui (compose instead).",
    "Keep all user-facing text in English.",
    "Do not introduce additional backend services or external databases; remain within the existing Internet Computer single-canister architecture."
  ],
  "nonGoals": [
    "Changing backend Motoko access control logic or APIs beyond what is required for the frontend startup fix.",
    "Implementing new authentication providers beyond Internet Identity.",
    "Addressing unrelated console warnings unless they are directly causing the startup hang."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}