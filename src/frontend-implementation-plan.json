{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Defer caffeineAdminToken URL handling to prevent startup Loading hang",
  "requirements": [
    {
      "id": "REQ-70",
      "summary": "Prevent actor initialization from reading/mutating the URL for caffeineAdminToken so startup cannot hang.",
      "acceptanceCriteria": [
        "`frontend/src/hooks/useActor.ts` no longer calls `getSecretParameter('caffeineAdminToken')` (or any other URL-reading helper) during actor initialization.",
        "Actor initialization does not call any helper that can invoke `history.replaceState` (directly or indirectly) during the `useQuery` `queryFn` in `useActor`.",
        "With a URL containing `#caffeineAdminToken=<token>`, the app renders past the startup Loading screen and the router can render the root route reliably before any URL cleanup occurs."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useActor.ts",
          "operation": "modify",
          "description": "Remove all caffeineAdminToken URL access from the actor `useQuery` initialization path (including `getSecretParameter`). Ensure the queryFn cannot trigger any hash/URL cleanup (e.g., history.replaceState) before the app mounts. Use the authorization component’s intended access-control initialization flow; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-71",
      "summary": "Read caffeineAdminToken only from sessionStorage and initialize access control only when a non-empty token exists.",
      "acceptanceCriteria": [
        "`useActor` reads caffeineAdminToken via a sessionStorage-based helper (e.g., `getSessionParameter('caffeineAdminToken')`) and never from the URL.",
        "`_initializeAccessControlWithSecret` is not called when the token is missing, null, empty string, or whitespace-only.",
        "When a valid token is present in sessionStorage, `_initializeAccessControlWithSecret` is called exactly once per actor creation and the authenticated experience functions as before."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useActor.ts",
          "operation": "modify",
          "description": "Update actor initialization to read `caffeineAdminToken` exclusively via a sessionStorage helper (e.g., `getSessionParameter`). Normalize by trimming and only call `actor._initializeAccessControlWithSecret` when the trimmed token is non-empty; otherwise skip the call. Use the authorization component’s access-control behavior as-is; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/urlParams.ts",
          "operation": "modify",
          "description": "Add/adjust a small sessionStorage-only helper (or enhance `getSessionParameter` usage) to support retrieving a trimmed token safely (treat missing/empty/whitespace as null) without touching `window.location`. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-72",
      "summary": "Implement non-mutating hash token reader that supports both `#caffeineAdminToken=...` and `#/route?caffeineAdminToken=...` styles.",
      "acceptanceCriteria": [
        "`readSecretFromHashNonMutating` correctly returns the token for `window.location.hash` equal to `#caffeineAdminToken=<token>`.",
        "`readSecretFromHashNonMutating` correctly returns the token for `window.location.hash` equal to `#/tasks?caffeineAdminToken=<token>` (and similar routes).",
        "`readSecretFromHashNonMutating` never calls `clearParamFromHash` or any API that mutates `window.location`/`window.history`.",
        "If the token is not present, the function returns null and does not throw for malformed/unexpected hash contents."
      ],
      "file_operations": [
        {
          "path": "frontend/src/utils/urlParams.ts",
          "operation": "modify",
          "description": "Create/repair and export `readSecretFromHashNonMutating(paramName)` that parses `window.location.hash` safely for both hash styles: direct params (`#key=value&...`) and route+query (`#/route?key=value&...`). Ensure it never mutates URL/history and always returns `string | null` without throwing on malformed hashes. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-73",
      "summary": "Ensure only useDeferredUrlCleanup reads caffeineAdminToken from the URL and that URL cleanup runs only after mount.",
      "acceptanceCriteria": [
        "The only place in the codebase that reads caffeineAdminToken from `window.location` is `frontend/src/hooks/useDeferredUrlCleanup.ts` (via `readSecretFromHashNonMutating`).",
        "URL cleanup (`clearParamFromHash('caffeineAdminToken')`) happens only inside the post-mount effect in `useDeferredUrlCleanup`, never during router creation or initial route validation.",
        "After mount, if caffeineAdminToken was present in the URL, it is persisted to sessionStorage and removed from the address bar without a page reload."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useDeferredUrlCleanup.ts",
          "operation": "modify",
          "description": "Ensure the post-mount effect is the single code path that (a) reads `caffeineAdminToken` from `window.location` via `readSecretFromHashNonMutating`, (b) persists it via `storeSessionParameter`, and (c) performs URL cleanup via `clearParamFromHash` without reload. Keep all URL mutation confined to this hook’s useEffect. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/urlParams.ts",
          "operation": "modify",
          "description": "Export `clearParamFromHash` for use by `useDeferredUrlCleanup`, and ensure no other exported helper used during startup/actor creation performs URL mutation. If `getSecretParameter/getSecretFromHash` remain, ensure they are not used for caffeineAdminToken outside `useDeferredUrlCleanup`. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Confirm `useDeferredUrlCleanup()` is called from a mounted route component (RootComponent) so cleanup runs only after mount, and avoid introducing any pre-mount router/search validation that reads or mutates the hash for caffeineAdminToken. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}