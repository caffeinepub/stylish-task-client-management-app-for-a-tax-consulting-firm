{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Remove URL mutation during actor initialization to prevent production blank screen",
  "requirements": [
    {
      "id": "REQ-74",
      "summary": "Remove caffeineAdminToken URL reads/mutations from actor creation; read token only from sessionStorage",
      "acceptanceCriteria": [
        "`frontend/src/hooks/useActor.ts` no longer imports or calls `getSecretParameter` (or any URL-reading helper that can call `history.replaceState`).",
        "Actor initialization does not call `history.replaceState` or otherwise change `window.location` during initial render / router bootstrap.",
        "App loads (no blank screen) when opening any route directly (e.g., `/`, `/tasks`, `/dashboard`) with and without a `#caffeineAdminToken=...` or `#/route?caffeineAdminToken=...` fragment present."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useActor.ts",
          "operation": "modify",
          "description": "Remove `getSecretParameter('caffeineAdminToken')` usage during actor creation; switch to reading the token from sessionStorage via `getSessionParameter('caffeineAdminToken')` from `frontend/src/utils/urlParams.ts`, ensuring actor creation does not touch `window.location` or `history.replaceState`."
        }
      ]
    },
    {
      "id": "REQ-75",
      "summary": "Call _initializeAccessControlWithSecret only when a non-empty caffeineAdminToken exists in sessionStorage",
      "acceptanceCriteria": [
        "When `sessionStorage.getItem('caffeineAdminToken')` is `null` or an empty/whitespace-only string, `useActor` creates the authenticated actor (when signed in) without calling `_initializeAccessControlWithSecret`.",
        "When `sessionStorage` contains a non-empty token, `_initializeAccessControlWithSecret(token)` is invoked exactly once per actor creation and does not block initial rendering indefinitely."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useActor.ts",
          "operation": "modify",
          "description": "Guard `_initializeAccessControlWithSecret` behind a non-empty, trimmed token from `getSessionParameter('caffeineAdminToken')`; avoid calling `_initializeAccessControlWithSecret` with an empty string and ensure the call is made at most once per actor creation."
        }
      ]
    },
    {
      "id": "REQ-76",
      "summary": "Ensure only useDeferredUrlCleanup reads caffeineAdminToken from the URL and performs cleanup after mount",
      "acceptanceCriteria": [
        "No code path other than `frontend/src/hooks/useDeferredUrlCleanup.ts` reads `caffeineAdminToken` from `window.location`.",
        "`useDeferredUrlCleanup` continues to (a) read the token using `readSecretFromHashNonMutating`, (b) store it to sessionStorage, and (c) clear it from the URL only inside an effect after the app has mounted.",
        "With a URL containing a token, the app renders first paint successfully before the token is removed from the address bar."
      ],
      "file_operations": [
        {
          "path": "frontend/src/utils/urlParams.ts",
          "operation": "modify",
          "description": "Export and/or implement URL-secret helpers required by `useDeferredUrlCleanup`: `readSecretFromHashNonMutating` (reads from hash without mutating history) and `clearParamFromHash` (performs `history.replaceState` cleanup). Ensure caffeineAdminToken URL parsing is only supported via these helpers so the only consumer is `frontend/src/hooks/useDeferredUrlCleanup.ts`."
        },
        {
          "path": "frontend/src/hooks/useDeferredUrlCleanup.ts",
          "operation": "modify",
          "description": "Confirm `useDeferredUrlCleanup` remains the sole place that reads `caffeineAdminToken` from `window.location`, continues using `readSecretFromHashNonMutating`, stores to sessionStorage, and clears the token from the URL only within the post-mount effect (keep all user-facing text in English)."
        }
      ]
    }
  ]
}